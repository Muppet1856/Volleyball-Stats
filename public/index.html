<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Volleyball Game Stats</title>
  <link rel="icon" type="image/svg+xml" sizes="any" href="volleyball.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">
  <link rel="manifest" href="/site.webmanifest">
  <script>
    (() => {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      const updateTheme = () => {
        document.documentElement.setAttribute('data-bs-theme', mediaQuery.matches ? 'dark' : 'light');
      };
      updateTheme();
      if (typeof mediaQuery.addEventListener === 'function') {
        mediaQuery.addEventListener('change', updateTheme);
      } else if (typeof mediaQuery.addListener === 'function') {
        mediaQuery.addListener(updateTheme);
      }
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/volleyball_stats.css">

</head>
<body>
<div id="loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999;">
  <div class="spinner-border text-primary" role="status"> <!-- Bootstrap spinner class -->
    <span class="visually-hidden">Loading...</span> <!-- For accessibility -->
  </div>
</div>
<div id="main-content" style="visibility: hidden;"> <!-- Your app's root div, initially hidden --><div id="main-content" style="visibility: hidden;"> <!-- Your app's root div, initially hidden -->
  <!-- Rest of your UI here, e.g., team names, scoreboards -->
</div>
<form id="matchForm" class="needs-validation" novalidate>
  <div class="container mt-4">
    <div class="section mb-3 d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#matchIndexModal">Saved Matches</button>
      <button type="button" class="btn btn-outline-success" id="newGameButton" onclick="startNewMatch()">New Game</button>
    </div>
    <div class="accordion mb-3" id="gameInfoAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingGameInfo">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGameInfo" aria-expanded="true" aria-controls="collapseGameInfo">
            Game Information
          </button>
        </h2>
        <div id="collapseGameInfo" class="accordion-collapse collapse show" aria-labelledby="headingGameInfo">
          <div class="accordion-body">
            <div class="game-info-grid row g-4 border rounded-3 p-3">
              <div class="col-12 col-lg-6">
                <label for="date" class="form-label">Date</label>
                <div class="input-group has-validation">
                  <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                  <input type="datetime-local" class="form-control" id="date" required aria-describedby="dateHelp">
                  <div class="invalid-feedback">Please choose the match date and time.</div>
                </div>
                <div id="dateHelp" class="form-text">A valid date and time are required before saving.</div>
              </div>
              <div class="col-12 col-lg-6">
                <label for="location" class="form-label">Location</label>
                <input type="text" class="form-control" id="location">
              </div>
              <div class="col-12 col-xl-6">
                <fieldset class="mb-0">
                  <legend class="form-label pt-0 mb-2">Type</legend>
                  <div class="d-flex flex-column gap-2">
                    <div class="form-check">
                      <input type="radio" class="form-check-input" id="tournament" name="gameType" value="tournament">
                      <label class="form-check-label" for="tournament">Tournament</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" class="form-check-input" id="league" name="gameType" value="league">
                      <label class="form-check-label" for="league">League</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" class="form-check-input" id="postSeason" name="gameType" value="postSeason">
                      <label class="form-check-label" for="postSeason">Post-Season</label>
                    </div>
                    <div class="form-check">
                      <input type="radio" class="form-check-input" id="nonLeague" name="gameType" value="nonLeague">
                      <label class="form-check-label" for="nonLeague">Non-League</label>
                    </div>
                  </div>
                </fieldset>
              </div>
              <div class="col-12 col-xl-6">
                <label for="opponent" class="form-label">Opponent</label>
                <input type="text" class="form-control" id="opponent">
              </div>
              <div class="col-12 col-md-6 col-xl-4">
                <label for="jerseyColorHome" class="form-label" id="jerseyColorHomeLabel" data-home-team-template="Jersey Color ({homeTeam})">Jersey Color (Home Team)</label>
                <select class="form-select jersey-select" id="jerseyColorHome">
                  <option class="jersey-option" value="white" data-color="#ffffff">White</option>
                  <option class="jersey-option" value="grey" data-color="#808080">Grey</option>
                  <option class="jersey-option" value="black" data-color="#000000">Black</option>
                  <option class="jersey-option" value="yellow" data-color="#ffd700">Yellow</option>
                  <option class="jersey-option" value="orange" data-color="#ff8c00">Orange</option>
                  <option class="jersey-option" value="red" data-color="#dc3545">Red</option>
                  <option class="jersey-option" value="green" data-color="#198754">Green</option>
                  <option class="jersey-option" value="blue" data-color="#0d6efd">Blue</option>
                  <option class="jersey-option" value="purple" data-color="#6f42c1">Purple</option>
                  <option class="jersey-option" value="pink" data-color="#d63384">Pink</option>
                </select>
              </div>
              <div class="col-12 col-md-6 col-xl-4">
                <label for="jerseyColorOpp" class="form-label" id="jerseyColorOppLabel" data-opp-team-template="Jersey Color ({oppTeam})">Jersey Color (Opponent)</label>
                <select class="form-select jersey-select" id="jerseyColorOpp">
                  <option class="jersey-option" value="white" data-color="#ffffff">White</option>
                  <option class="jersey-option" value="grey" data-color="#808080" selected>Grey</option>
                  <option class="jersey-option" value="black" data-color="#000000">Black</option>
                  <option class="jersey-option" value="yellow" data-color="#ffd700">Yellow</option>
                  <option class="jersey-option" value="orange" data-color="#ff8c00">Orange</option>
                  <option class="jersey-option" value="red" data-color="#dc3545">Red</option>
                  <option class="jersey-option" value="green" data-color="#198754">Green</option>
                  <option class="jersey-option" value="blue" data-color="#0d6efd">Blue</option>
                  <option class="jersey-option" value="purple" data-color="#6f42c1">Purple</option>
                  <option class="jersey-option" value="pink" data-color="#d63384">Pink</option>
                </select>
              </div>
              <div class="col-12">
                <p class="text-muted small mb-0">Note: If both teams have the same color, choose the libero color.</p>
              </div>
              <div class="col-12 col-xl-6">
                <fieldset class="mb-0">
                  <legend class="form-label fs-6 mb-2">Result of Game</legend>
                  <div class="result-summary">
                    <div class="result-team">
                      <label for="resultHome" class="form-label mb-0" id="resultHomeLabel" data-home-team-template="{homeTeam}">Home Team</label>
                      <select class="form-select w-auto text-center" id="resultHome">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                      </select>
                    </div>
                    <span class="result-vs">vs</span>
                    <div class="result-team">
                      <label for="resultOpp" class="form-label mb-0" id="resultOppLabel" data-opp-team-template="{oppTeam}">Opponent</label>
                      <select class="form-select w-auto text-center" id="resultOpp">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                      </select>
                    </div>
                  </div>
                </fieldset>
              </div>
              <div class="col-12 col-xl-6">
                <label for="firstServer" class="form-label">First Serve</label>
                <select class="form-select" id="firstServer">
                  <option class="firstServer" data-home-team-template="{homeTeam}">Home Team</option>
                  <option class="firstServer" data-opp-team-template="{oppTeam}">Opponent</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion mb-4" id="playersAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingPlayers">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlayers" aria-expanded="true" aria-controls="collapsePlayers">
            <span id="playersSectionTitle" data-home-team-template="Players Appearing in Match ({homeTeam})">Players Appearing in Match (Home Team)</span>
          </button>
        </h2>
        <div id="collapsePlayers" class="accordion-collapse collapse show" aria-labelledby="headingPlayers">
          <div class="accordion-body">
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#playerModal">Manage Roster</button>
              <button type="button" class="btn btn-outline-secondary" id="playerSortToggleBtn" aria-pressed="false" title="Sorted numerically by jersey number.">Sort: Number</button>
            </div>
            <div id="playerList" class="border p-2"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2 class="mb-3">Set-by-Set Scoring</h2>
      <div class="mb-2 text-center">
        <button id="swapTeamsBtn" type="button" class="btn btn-secondary swap-btn"></button>
      </div>
      <table class="table table-bordered set-table" id="scoring-table">
        <tr>
          <th class="set-index-header">Set</th>
          <th class="left-score header-cell" id="homeHeader">
            <button type="button" class="team-name-button" data-team-header="home" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" data-bs-content="Home Team" data-home-team-template="{homeTeam}">Home Team</button>
          </th>
          <th class="right-score header-cell" id="oppHeader">
            <button type="button" class="team-name-button" data-team-header="opp" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="bottom" data-bs-content="Opponent" data-opp-team-template="{oppTeam}">Opponent</button>
          </th>
          <th></th>
        </tr>
        <tr>
          <th scope="row" class="set-index-cell">
            <i class="bi bi-1-circle-fill" aria-hidden="true"></i>
            <span class="visually-hidden">Set 1</span>
          </th>
          <td><input type="number" class="form-control left-score" id="set1Home" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td><input type="number" class="form-control right-score" id="set1Opp" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td class="set-actions">
            <div class="set-actions-stack">
              <button type="button" class="btn btn-outline-dark score-game-btn" data-bs-toggle="modal" data-bs-target="#scoreGameModal" data-set="1">Score Game</button>
              <button type="button" class="btn btn-primary finalize-button" data-bs-toggle="button" data-set="1">Final</button>
            </div>
          </td>
        </tr>
        <tr>
          <th scope="row" class="set-index-cell">
            <i class="bi bi-2-circle" aria-hidden="true"></i>
            <span class="visually-hidden">Set 2</span>
          </th>
          <td><input type="number" class="form-control left-score" id="set2Home" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td><input type="number" class="form-control right-score" id="set2Opp" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td class="set-actions">
            <div class="set-actions-stack">
              <button type="button" class="btn btn-outline-dark score-game-btn" data-bs-toggle="modal" data-bs-target="#scoreGameModal" data-set="2">Score Game</button>
              <button type="button" class="btn btn-primary finalize-button" data-bs-toggle="button" data-set="2">Final</button>
            </div>
          </td>
        </tr>
        <tr>
          <th scope="row" class="set-index-cell">
            <i class="bi bi-3-circle-fill" aria-hidden="true"></i>
            <span class="visually-hidden">Set 3</span>
          </th>
          <td><input type="number" class="form-control left-score" id="set3Home" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td><input type="number" class="form-control right-score" id="set3Opp" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td class="set-actions">
            <div class="set-actions-stack">
              <button type="button" class="btn btn-outline-dark score-game-btn" data-bs-toggle="modal" data-bs-target="#scoreGameModal" data-set="3">Score Game</button>
              <button type="button" class="btn btn-primary finalize-button" data-bs-toggle="button" data-set="3">Final</button>
            </div>
          </td>
        </tr>
        <tr>
          <th scope="row" class="set-index-cell">
            <i class="bi bi-4-circle" aria-hidden="true"></i>
            <span class="visually-hidden">Set 4</span>
          </th>
          <td><input type="number" class="form-control left-score" id="set4Home" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td><input type="number" class="form-control right-score" id="set4Opp" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td class="set-actions">
            <div class="set-actions-stack">
              <button type="button" class="btn btn-outline-dark score-game-btn" data-bs-toggle="modal" data-bs-target="#scoreGameModal" data-set="4">Score Game</button>
              <button type="button" class="btn btn-primary finalize-button" data-bs-toggle="button" data-set="4">Final</button>
            </div>
          </td>
        </tr>
        <tr>
          <th scope="row" class="set-index-cell">
            <i class="bi bi-5-circle-fill" aria-hidden="true"></i>
            <span class="visually-hidden">Set 5</span>
          </th>
          <td><input type="number" class="form-control left-score" id="set5Home" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td><input type="number" class="form-control right-score" id="set5Opp" min="0" max="99" inputmode="numeric" pattern="[0-9]*"></td>
          <td class="set-actions">
            <div class="set-actions-stack">
              <button type="button" class="btn btn-outline-dark score-game-btn" data-bs-toggle="modal" data-bs-target="#scoreGameModal" data-set="5">Score Game</button>
              <button type="button" class="btn btn-primary finalize-button" data-bs-toggle="button" data-set="5">Final</button>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <div id="scoreGameModal" class="modal fade" tabindex="-1" aria-labelledby="scoreGameModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content score-modal">
          <div class="modal-header">
            <h5 class="modal-title" id="scoreGameModalLabel">Score Game</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="scoreboard-wrapper">
              <button type="button" class="btn btn-light modal-swap-btn swap-btn" id="scoreModalSwapBtn" aria-label="Swap team sides"></button>
              <div class="team-panel team-blue">
                <span class="score-team-label" id="scoreGameLeftLabel" data-home-team-template="{homeTeam}">Home Team</span>
                <div class="score-zone increment" role="button" tabindex="0" data-team="home" data-action="increment" aria-label="Increase Home Team score"></div>
                <div class="score-zone decrement" role="button" tabindex="0" data-team="home" data-action="decrement" aria-label="Decrease Home Team score"></div>
                <div class="score-value" id="scoreGameHomeDisplay">00</div>
              </div>
              <div class="team-panel team-red">
                <span class="score-team-label" id="scoreGameRightLabel" data-opp-team-template="{oppTeam}">Opponent</span>
                <div class="score-zone increment" role="button" tabindex="0" data-team="opp" data-action="increment" aria-label="Increase opponent score"></div>
                <div class="score-zone decrement" role="button" tabindex="0" data-team="opp" data-action="decrement" aria-label="Decrease opponent score"></div>
                <div class="score-value" id="scoreGameOppDisplay">00</div>
              </div>
            </div>
            <!-- Updated timeout-row in the modal (add classes to timeout-container) -->
            <div class="timeout-row" role="group" aria-label="Timeout controls">
              <div class="timeout-bar">
                <div class="timeout-container left-timeout" data-team="home" aria-label="Home Team timeouts">
                  <div class="timeout-boxes">
                    <button type="button" class="timeout-box btn team-blue" data-team="home" data-timeout-index="0" aria-pressed="false" aria-label="Home Team first timeout available">
                      <span class="timeout-box-text">TO</span>
                    </button>
                    <button type="button" class="timeout-box btn team-blue" data-team="home" data-timeout-index="1" aria-pressed="false" aria-label="Home Team second timeout available">
                      <span class="timeout-box-text">TO</span>
                    </button>
                  </div>
                </div>
                <div class="timeout-container right-timeout" data-team="opp" aria-label="Opponent timeouts">
                  <div class="timeout-boxes">
                    <button type="button" class="timeout-box btn team-red" data-team="opp" data-timeout-index="0" aria-pressed="false" aria-label="Opponent first timeout available">
                      <span class="timeout-box-text">TO</span>
                    </button>
                    <button type="button" class="timeout-box btn team-red" data-team="opp" data-timeout-index="1" aria-pressed="false" aria-label="Opponent second timeout available">
                      <span class="timeout-box-text">TO</span>
                    </button>
                  </div>
                </div>
              </div>
              <div id="scoreGameTimeoutDisplay" class="timeout-timer-display" role="status" aria-live="polite"></div>
              <div id="timeoutContainer" class="mt-4 position-relative" style="height: 30px; display: none;" aria-live="polite" aria-atomic="true">
                  <div class="progress w-100 h-100" style="direction: rtl;">
                      <div
                          id="scoreGameTimeoutSrStatus"
                          class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                          role="progressbar"
                          aria-valuemin="0"
                          aria-valuemax="60"
                          aria-valuenow="60"
                          style="width: 100%; transition: width 1s linear;"
                      ></div>
                  </div>

                  <!-- Centered overlay text -->
                  <div id="timeoutCenteredLabel"
                       class="position-absolute top-50 start-50 translate-middle fw-bold"
                       style="pointer-events: none;">
                      1:00
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <span id="autoSaveStatus" class="text-muted d-none" aria-live="polite"></span>
    </div>

    <div id="playerModal" class="modal fade" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="playerModalLabel">Manage Roster</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="player-form-controls">
              <div class="row g-2">
                <div class="col"><input type="number" class="form-control" id="number" placeholder="Number" min="0" inputmode="numeric" pattern="[0-9]*"></div>
                <div class="col"><input type="text" class="form-control" id="lastName" placeholder="Lastname"></div>
                <div class="col"><input type="text" class="form-control" id="initial" placeholder="Initial (optional)"></div>
                <div class="col">
                  <label for="tempNumber" class="form-label visually-hidden">Temporary number (optional)</label>
                  <input type="number" class="form-control" id="tempNumber" placeholder="Temp # (optional)" min="0" inputmode="numeric" pattern="[0-9]*" aria-describedby="tempNumberHelp">
                  <div id="tempNumberHelp" class="visually-hidden">Temporary jersey number used for this match only.</div>
                </div>
              </div>
              <div id="playerFormError" class="alert alert-danger d-none mt-2 mb-0" role="alert"></div>
              <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary" id="savePlayerBtn" onclick="submitPlayer()">Add Player</button>
                <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">Cancel</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
            <div class="modal-player-controls d-flex justify-content-between align-items-center mt-3 mb-2 flex-wrap gap-2">
              <h6 class="mb-0">Current Roster</h6>
              <div class="d-flex align-items-center gap-2">
                <label for="modalPlayerSortSelect" class="form-label mb-0">Sort by</label>
                <select id="modalPlayerSortSelect" class="form-select form-select-sm" aria-label="Sort players in roster">
                  <option value="number">Number</option>
                  <option value="name">Name</option>
                </select>
              </div>
            </div>
            <div id="modalPlayerList" class="modal-player-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="matchIndexModal" class="modal fade" tabindex="-1" aria-labelledby="matchIndexModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="matchIndexModalLabel">Saved Matches</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul id="matchList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>

    <div id="jerseyConflictModal" class="modal fade" tabindex="-1" aria-labelledby="jerseyConflictModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="jerseyConflictModalLabel">Jersey Color Conflict</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="jerseyConflictModalMessage" class="mb-0">Jersey colors must be different. If both teams have the same color, choose the libero color.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="js/volleyball_stats.js" defer></script>
</div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a25550c3ad70044',t:'MTc2Mzc4MjA1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>